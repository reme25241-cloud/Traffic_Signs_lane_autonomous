{% extends 'base.html' %}
{% load static %}
{% block content %}

<div class="container mt-5">
  <div class="card shadow p-4 bg-light border-primary border-3">
    <h3 class="text-center mb-4 text-primary">ðŸš¦ Live Traffic Sign Classifier</h3>

    <!-- Camera Controls -->
    <div class="text-center mb-3">
      <button id="startCamera" class="btn btn-success me-2">ðŸ“· Start Camera</button>
      <button id="stopCamera" class="btn btn-danger">â›” Stop Camera</button>
    </div>

    <!-- Live Camera -->
    <div class="text-center mb-4">
      <video id="webcam"
             autoplay
             playsinline
             class="img-fluid rounded border border-primary"
             style="max-height:300px; display:none;">
      </video>
    </div>

    <!-- Prediction Output -->
    <div class="row">
      <div class="col-12">
        <div id="label-container"
             class="bg-white p-4 rounded shadow-sm border border-secondary">
          <div class="text-muted text-center">
            Start the camera to begin live prediction
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- TensorFlow + Teachable Machine -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
<script>
/* ======================================================
   FULL SIGN METADATA (UNCHANGED)
====================================================== */
const signInfo = {
  "stop sign": {
    use: "Come to a complete stop before proceeding.",
    advantages: [
      "Prevents collisions at intersections",
      "Clear instruction for all drivers"
    ],
    disadvantages: [
      "Ignoring it increases crash risk",
      "Stops can cause minor congestion"
    ],
    notes: "Stop fully, check traffic, then go."
  },
  "Bumps": {
    use: "Warns about road bumps/speed breakers ahead.",
    advantages: [
      "Reduces vehicle damage",
      "Improves safety near bumps"
    ],
    disadvantages: [
      "May slow traffic",
      "If ignored, may cause discomfort/damage"
    ],
    notes: "Slow down before the bump."
  },
  "One Way": {
    use: "Traffic must move only in the indicated direction.",
    advantages: [
      "Improves traffic flow",
      "Reduces head-on collision risk"
    ],
    disadvantages: [
      "Wrong-way entry is dangerous",
      "Needs clear signage in complex areas"
    ],
    notes: "Follow arrow direction strictly."
  },
  "School Ahead": {
    use: "School zone ahead; drive carefully and reduce speed.",
    advantages: [
      "Protects pedestrians/children",
      "Encourages cautious driving"
    ],
    disadvantages: [
      "Congestion during school hours",
      "Requires strict enforcement"
    ],
    notes: "Slow down; watch for children."
  },
  "U Turn": {
    use: "U-turn permitted where indicated.",
    advantages: [
      "Helps route correction",
      "Legal turning guidance"
    ],
    disadvantages: [
      "Unsafe if visibility is poor",
      "May block traffic briefly"
    ],
    notes: "Ensure it is safe before turning."
  },
  "Aid Station": {
    use: "Medical help available nearby.",
    advantages: [
      "Useful in emergencies",
      "Improves driver confidence"
    ],
    disadvantages: [
      "Not always available",
      "Requires maintenance"
    ],
    notes: "Follow sign directions."
  },
  "No Entry": {
    use: "Entry is prohibited.",
    advantages: [
      "Prevents wrong-way driving",
      "Improves traffic safety"
    ],
    disadvantages: [
      "Confusing if poorly placed",
      "Needs enforcement"
    ],
    notes: "Do not enter."
  },
  "Maximum Speed": {
    use: "Maximum legal speed limit.",
    advantages: [
      "Improves road safety",
      "Standardizes traffic flow"
    ],
    disadvantages: [
      "Ignored by some drivers",
      "Needs monitoring"
    ],
    notes: "Stay under the limit."
  },
  "Zebra crossing": {
    use: "Pedestrian crossing ahead.",
    advantages: [
      "Improves pedestrian safety",
      "Clear crossing point"
    ],
    disadvantages: [
      "Faded markings reduce visibility",
      "Requires driver compliance"
    ],
    notes: "Yield to pedestrians."
  },
  "Left Turn": {
    use: "Left turn permitted or required.",
    advantages: [
      "Guides turning behavior",
      "Reduces confusion"
    ],
    disadvantages: [
      "Unsafe if rules ignored",
      "Needs clear markings"
    ],
    notes: "Signal and turn carefully."
  },
  "Right Turn": {
    use: "Right turn permitted or required.",
    advantages: [
      "Guides turning behavior",
      "Reduces confusion"
    ],
    disadvantages: [
      "Unsafe if rules ignored",
      "Needs clear markings"
    ],
    notes: "Signal and turn carefully."
  },
  "Horn Prohibited": {
    use: "No honking allowed.",
    advantages: [
      "Reduces noise pollution",
      "Improves area comfort"
    ],
    disadvantages: [
      "Less warning sound",
      "Depends on compliance"
    ],
    notes: "Avoid honking."
  },
  "Two Way Road": {
    use: "Two-way traffic ahead.",
    advantages: [
      "Warns about oncoming vehicles",
      "Reduces head-on collisions"
    ],
    disadvantages: [
      "Dangerous overtaking",
      "Needs lane discipline"
    ],
    notes: "Stay in lane."
  },
  "Train Crossing": {
    use: "Railway crossing ahead.",
    advantages: [
      "Prevents severe accidents",
      "Encourages early braking"
    ],
    disadvantages: [
      "Ignored if rarely used",
      "Needs clear visibility"
    ],
    notes: "Stop and look both ways."
  },
  "Restricted Zone": {
    use: "Restricted access area.",
    advantages: [
      "Improves safety",
      "Controls traffic"
    ],
    disadvantages: [
      "Confusing if unclear",
      "Needs enforcement"
    ],
    notes: "Follow restrictions."
  },
  "No Overtaking": {
    use: "Overtaking prohibited.",
    advantages: [
      "Prevents risky passing",
      "Safer roads"
    ],
    disadvantages: [
      "Slower traffic",
      "Requires compliance"
    ],
    notes: "Do not overtake."
  },
  "Traffic Signal": {
    use: "Traffic signal ahead.",
    advantages: [
      "Prepares drivers to stop",
      "Improves intersection safety"
    ],
    disadvantages: [
      "Ignored by rash drivers",
      "Needs maintenance"
    ],
    notes: "Prepare to stop."
  },
  "Narrow Road": {
    use: "Road narrows ahead.",
    advantages: [
      "Reduces side collisions",
      "Promotes caution"
    ],
    disadvantages: [
      "Creates bottlenecks",
      "Needs markings"
    ],
    notes: "Slow down."
  },
  "Diesel Fuel": {
    use: "Diesel fuel available nearby.",
    advantages: [
      "Helps locate fuel",
      "Avoids breakdowns"
    ],
    disadvantages: [
      "Outdated signs mislead",
      "Station availability varies"
    ],
    notes: "Confirm station."
  },
  "No Parking": {
    use: "Parking prohibited.",
    advantages: [
      "Keeps roads clear",
      "Improves traffic flow"
    ],
    disadvantages: [
      "Limited parking options",
      "Needs enforcement"
    ],
    notes: "Do not park."
  }
};

/* ======================================================
   MODEL + CAMERA LOGIC
====================================================== */
const URL = "https://teachablemachine.withgoogle.com/models/oZlftKGPQ/";
let model, stream, interval;

async function initModel() {
  model = await tmImage.load(URL + "model.json", URL + "metadata.json");
}

async function startCamera() {
  await initModel();
  const video = document.getElementById("webcam");

  stream = await navigator.mediaDevices.getUserMedia({ video: true });
  video.srcObject = stream;
  video.style.display = "block";

  interval = setInterval(predict, 800);
}

function stopCamera() {
  clearInterval(interval);
  if (stream) stream.getTracks().forEach(t => t.stop());
}

async function predict() {
  const video = document.getElementById("webcam");
  const preds = await model.predict(video);
  const best = preds.reduce((a, b) => a.probability > b.probability ? a : b);

  const label = best.className.trim();
  const confidence = best.probability * 100;
  const box = document.getElementById("label-container");

  if (confidence < 90) {
    box.innerHTML = `<div class="alert alert-warning">Low confidence (${confidence.toFixed(2)}%)</div>`;
    return;
  }

  const info = signInfo[label];
  if (!info) return;

  box.innerHTML = `
    <h5 class="text-primary">${label} (${confidence.toFixed(2)}%)</h5>
    <p><strong>Meaning:</strong> ${info.use}</p>
    <p><strong>Advantages:</strong></p>
    <ul>${info.advantages.map(a => `<li>${a}</li>`).join("")}</ul>
    <p><strong>Disadvantages:</strong></p>
    <ul>${info.disadvantages.map(d => `<li>${d}</li>`).join("")}</ul>
    <p><strong>Notes:</strong> ${info.notes}</p>
  `;

  sendPredictionToBackend(label, confidence, info.notes);
}

function sendPredictionToBackend(label, confidence, notes) {
  fetch("/save-prediction/", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCookie("csrftoken")
    },
    body: JSON.stringify({ predicted_sign: label, confidence, notes })
  });
}

function getCookie(name) {
  return document.cookie.split("; ")
    .find(row => row.startsWith(name + "="))
    ?.split("=")[1];
}

document.getElementById("startCamera").onclick = startCamera;
document.getElementById("stopCamera").onclick = stopCamera;
</script>
{% endblock %}
